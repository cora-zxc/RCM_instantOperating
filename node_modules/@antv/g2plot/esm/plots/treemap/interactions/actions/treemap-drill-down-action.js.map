{"version":3,"file":"treemap-drill-down-action.js","sourceRoot":"","sources":["../../../../../src/plots/treemap/interactions/actions/treemap-drill-down-action.ts"],"names":[],"mappings":"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","sourcesContent":["import { Action, IGroup, Util } from '@antv/g2';\nimport { get, isArray } from '@antv/util';\nimport { deepAssign } from '../../../../utils/deep-assign';\nimport { transformData } from '../../utils';\n\n// 面包屑文字和分割符'/'之间的距离\nconst PADDING = 4;\n// 面包屑位置距离树图的距离\nconst PADDING_LEFT = 0;\nconst PADDING_TOP = 5;\n// 面包屑默认配置\nconst DEFAULT_BREAD_CRUMB_CONFIG = {\n  name: 'treemap-bread-crumb',\n  rootText: '初始',\n  dividerText: '/',\n  textStyle: {\n    fontSize: 12,\n    fill: 'rgba(0, 0, 0, 0.65)',\n    cursor: 'pointer',\n  },\n  activeStyle: {\n    fill: '#87B5FF',\n  },\n};\nexport class TreemapDrillDownAction extends Action {\n  // 存储历史下钻数据\n  public historyCache: Record<string, any>[] = null;\n  // 面包屑 group\n  private breadCrumbGroup: IGroup = null;\n  // 面包屑基础配置\n  private breadCrumbCfg = DEFAULT_BREAD_CRUMB_CONFIG;\n\n  /**\n   * 获取 mix 默认的配置和用户配置\n   */\n  private getButtonCfg() {\n    return deepAssign(this.breadCrumbCfg, this.cfg);\n  }\n\n  /**\n   * 下钻数据并更新 view 显示层\n   * @param data 下钻数据\n   */\n  private drill(data) {\n    const config = this.getButtonCfg();\n    const { view } = this.context;\n    const currentData = view.getData();\n    const groupScales = view.getGroupScales();\n    const hierarchyConfig = get(view, ['interactions', 'treemap-drill-down', 'cfg', 'hierarchyConfig'], {});\n\n    // 初始化cache 数据\n    if (!this.historyCache) {\n      this.historyCache = [\n        {\n          // 当前会默认打平第一层，因此无法获取第一层的 name，暂用初始代替\n          name: config.rootText,\n          children: currentData,\n        },\n      ];\n    }\n\n    // 重新 update 数据\n    const drillData = transformData({\n      data,\n      colorField: get(groupScales, [0, 'field']),\n      enableDrillDown: true,\n      hierarchyConfig,\n    });\n\n    view.changeData(drillData);\n\n    // 增加历史记录\n    this.historyCache.push({\n      name: data.name,\n      children: drillData,\n    });\n  }\n\n  /**\n   * 显示面包屑\n   */\n  public drawBreadCrumb() {\n    this.drawBreadCrumbGroup();\n    this.resetPosition();\n    this.breadCrumbGroup.show();\n  }\n\n  /**\n   * 绘制 Button 和 文本\n   */\n  private drawBreadCrumbGroup() {\n    const config = this.getButtonCfg();\n    const historyCache = this.historyCache;\n\n    // 初始化面包屑 group\n    if (!this.breadCrumbGroup) {\n      this.breadCrumbGroup = this.context.view.foregroundGroup.addGroup({\n        name: config.name,\n      });\n    } else {\n      this.breadCrumbGroup.clear();\n    }\n\n    // 绘制面包屑\n    let left = 0;\n    historyCache.forEach((record, index) => {\n      // 添加文本\n      const textShape = this.breadCrumbGroup.addShape({\n        type: 'text',\n        name: `${config.name}_${record.name}_text`,\n        attrs: {\n          text: record.name,\n          ...config.textStyle,\n          x: left,\n          y: 0,\n        },\n      });\n\n      const textShapeBox = textShape.getBBox();\n      left += textShapeBox.width + PADDING;\n\n      // 增加文本事件\n      textShape.on('click', () => {\n        const newHistoryCache = historyCache.slice(0, index + 1);\n        this.back(newHistoryCache);\n      });\n\n      // active 效果内置\n      textShape.on('mouseenter', () => {\n        textShape.attr(config.activeStyle);\n      });\n      textShape.on('mouseleave', () => {\n        textShape.attr(config.textStyle);\n      });\n\n      if (index < historyCache.length - 1) {\n        // 添加反斜杠\n        const dividerShape = this.breadCrumbGroup.addShape({\n          type: 'text',\n          name: `${config.name}_${record.name}_divider`,\n          attrs: {\n            text: config.dividerText,\n            ...config.textStyle,\n            x: left,\n            y: 0,\n          },\n        });\n\n        const dividerBox = dividerShape.getBBox();\n        left += dividerBox.width + PADDING;\n      }\n    });\n  }\n\n  /**\n   * 重置位置，初始化及触发 chart  afterchangesize 回调时使用\n   */\n  public resetPosition() {\n    // 当在第一层级未绘制面包屑，此时 changedata 触发 resetPosition 函数，需判断 this.breadCrumbGroup 是否存在\n    if (!this.breadCrumbGroup) return;\n    const view = this.context.view;\n    const coord = view.getCoordinate();\n    const point = coord.convert({ x: 0, y: 1 });\n    const breadCrumbGroup = this.breadCrumbGroup;\n    const bbox = breadCrumbGroup.getBBox();\n    const matrix = Util.transform(null, [['t', point.x + PADDING_LEFT, point.y + bbox.height + PADDING_TOP]]);\n    breadCrumbGroup.setMatrix(matrix);\n  }\n\n  /**\n   * 隐藏面包屑\n   */\n  private hideCrumbGroup() {\n    if (this.breadCrumbGroup) {\n      this.breadCrumbGroup.hide();\n    }\n  }\n\n  /**\n   * 点击事件, 下钻数据，并绘制面包屑\n   */\n  public click() {\n    const data = get(this.context, ['event', 'data', 'data']);\n    if (!data) return false;\n    this.drill(data);\n    this.drawBreadCrumb();\n  }\n\n  /**\n   * 回退事件，点击面包屑时触发\n   * @param historyCache 当前要回退到的历史\n   */\n  public back(historyCache) {\n    const { view } = this.context;\n    if (!isArray(this.historyCache) || this.historyCache.length <= 0) {\n      return;\n    }\n    this.historyCache = historyCache;\n    const data = historyCache[historyCache.length - 1].children;\n    view.changeData(data);\n    if (historyCache.length > 1) {\n      this.drawBreadCrumb();\n    } else {\n      this.hideCrumbGroup();\n    }\n  }\n\n  /**\n   * reset: 重置面包屑置初始状态，chart changeData 时使用\n   */\n  public reset() {\n    this.historyCache = null;\n    this.hideCrumbGroup();\n  }\n\n  /**\n   * destroy: 销毁资源\n   */\n  public destroy() {\n    if (this.breadCrumbGroup) {\n      this.breadCrumbGroup.remove();\n    }\n    super.destroy();\n  }\n}\n"]}